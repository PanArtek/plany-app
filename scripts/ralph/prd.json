{
  "project": "PLANY App",
  "branchName": "ralph/flatten-labor-pricing",
  "description": "Flatten labor pricing model: replace norma × stawka per component with flat cena_robocizny per position",
  "mode": "feature",
  "baseBranch": "main",
  "userStories": [
    {
      "id": "US-001",
      "title": "DB migration: add new columns and type, migrate data",
      "description": "Apply a single Supabase migration `017_flatten_labor_pricing` that:\n\n1. CREATE TYPE `cena_robocizny_zrodlo` AS ENUM ('biblioteka', 'podwykonawca', 'reczna')\n2. ALTER TABLE `pozycje_biblioteka` ADD COLUMN `cena_robocizny` DECIMAL(12,2) — nullable\n3. ALTER TABLE `kosztorys_pozycje` ADD 4 columns:\n   - `cena_robocizny` DECIMAL(12,2) NOT NULL DEFAULT 0\n   - `cena_robocizny_zrodlowa` DECIMAL(12,2)\n   - `cena_robocizny_zrodlo` cena_robocizny_zrodlo\n   - `podwykonawca_id` UUID REFERENCES podwykonawcy(id) ON DELETE SET NULL\n4. Migrate biblioteka data: UPDATE pozycje_biblioteka SET cena_robocizny = SUM(stawka_domyslna × norma_domyslna) from biblioteka_skladowe_robocizna\n5. DISABLE trigger kosztorys_pozycje_check_locked (for locked revision migration)\n6. Migrate kosztorys data:\n   - auto (is_manual=false): SUM(stawka × norma) → cena_robocizny per unit\n   - manual (is_manual=true): SUM(stawka × ilosc) / kp.ilosc → convert to per unit\n   - Set cena_robocizny_zrodlowa = same value, cena_robocizny_zrodlo = 'biblioteka'\n   - Migrate podwykonawca_id from first skladowa (lp=1) per position\n7. ENABLE trigger kosztorys_pozycje_check_locked\n\nSee full SQL in docs/REDESIGN-ROBOCIZNA.md section 3 (steps 1-5).\n\nIMPORTANT: Do NOT drop any tables or views yet. This migration is additive only — the old tables still exist after this step.\n\nApply via `supabase.rpc` or `apply_migration` tool. Verify data migrated correctly by querying a few rows.",
      "acceptanceCriteria": [
        "TYPE cena_robocizny_zrodlo exists with values: biblioteka, podwykonawca, reczna",
        "pozycje_biblioteka has cena_robocizny column (nullable DECIMAL)",
        "kosztorys_pozycje has cena_robocizny, cena_robocizny_zrodlowa, cena_robocizny_zrodlo, podwykonawca_id columns",
        "Biblioteka positions with robocizna skladowe have cena_robocizny = SUM(stawka_domyslna * norma_domyslna)",
        "Kosztorys positions with robocizna skladowe have cena_robocizny populated with correct per-unit value",
        "cena_robocizny_zrodlowa equals cena_robocizny for migrated rows",
        "podwykonawca_id populated from first skladowa where available",
        "Old tables (biblioteka_skladowe_robocizna, kosztorys_skladowe_robocizna) still exist",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Migration 017_flatten_labor_pricing applied. All data migrated correctly. Old tables preserved.",
      "dependsOn": []
    },
    {
      "id": "US-002",
      "title": "DB migration: recreate views and copy_revision without robocizna tables",
      "description": "Apply a second Supabase migration `018_flatten_labor_views` that:\n\n1. DROP VIEW IF EXISTS rewizje_summary\n2. DROP VIEW IF EXISTS kosztorys_pozycje_view\n3. CREATE new `kosztorys_pozycje_view` where R = kp.cena_robocizny × kp.ilosc (flat, no subquery on skladowe_robocizna). View must expose:\n   - All existing columns from kp\n   - r_jednostkowy = kp.cena_robocizny\n   - r_robocizna = kp.cena_robocizny × kp.ilosc\n   - cena_robocizny_zrodlowa, cena_robocizny_zrodlo, podwykonawca_id\n   - r_is_override = (kp.cena_robocizny IS DISTINCT FROM kp.cena_robocizny_zrodlowa)\n   - Material calculation UNCHANGED (LEFT JOIN on kosztorys_skladowe_materialy)\n   - r_plus_m, narzut_wartosc, razem recalculated with new R formula\n   - security_invoker = true\n4. CREATE new `rewizje_summary` with R from kosztorys_pozycje.cena_robocizny (no skladowe_robocizna subquery). Include is_accepted, accepted_at from rewizje. security_invoker = true.\n5. CREATE OR REPLACE `private.copy_revision()` — copy new columns (cena_robocizny, cena_robocizny_zrodlowa, cena_robocizny_zrodlo, podwykonawca_id) in the position INSERT. Remove the INSERT INTO kosztorys_skladowe_robocizna block. Keep materialy copy unchanged.\n\nSee full SQL in docs/REDESIGN-ROBOCIZNA.md section 3 (steps 6-7).\n\nVerify: SELECT from kosztorys_pozycje_view returns correct r_robocizna matching old values.",
      "acceptanceCriteria": [
        "kosztorys_pozycje_view exists with r_jednostkowy = cena_robocizny (no skladowe R subquery)",
        "kosztorys_pozycje_view exposes cena_robocizny_zrodlowa, cena_robocizny_zrodlo, podwykonawca_id, r_is_override",
        "rewizje_summary exists with suma_r calculated from kp.cena_robocizny * kp.ilosc",
        "rewizje_summary includes is_accepted and accepted_at columns",
        "private.copy_revision copies cena_robocizny, cena_robocizny_zrodlowa, cena_robocizny_zrodlo, podwykonawca_id",
        "private.copy_revision does NOT copy kosztorys_skladowe_robocizna",
        "View calculations produce same totals as before migration (within rounding)",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Migration 018_flatten_labor_views applied. Views recreated with flat R formula. copy_revision copies new columns, no robocizna copy.",
      "dependsOn": ["US-001"]
    },
    {
      "id": "US-003",
      "title": "DB migration: drop robocizna tables, triggers, policies",
      "description": "Apply a third migration `019_drop_robocizna_tables` that cleans up:\n\n1. DROP TRIGGER IF EXISTS ksz_skladowe_r_check_locked ON kosztorys_skladowe_robocizna\n2. DROP TRIGGER IF EXISTS kosztorys_skladowe_r_updated_at ON kosztorys_skladowe_robocizna\n3. DROP POLICY IF EXISTS bib_skladowe_r_select/insert/update/delete ON biblioteka_skladowe_robocizna (4 policies)\n4. DROP POLICY IF EXISTS ksz_skladowe_r_select/insert/update/delete ON kosztorys_skladowe_robocizna (4 policies)\n5. DROP TABLE IF EXISTS kosztorys_skladowe_robocizna CASCADE\n6. DROP TABLE IF EXISTS biblioteka_skladowe_robocizna CASCADE\n\nVerify: tables no longer exist, views still work correctly.",
      "acceptanceCriteria": [
        "Table kosztorys_skladowe_robocizna does not exist",
        "Table biblioteka_skladowe_robocizna does not exist",
        "All 8 RLS policies dropped (4 bib_skladowe_r_*, 4 ksz_skladowe_r_*)",
        "Both triggers dropped",
        "kosztorys_pozycje_view still returns data correctly",
        "rewizje_summary still returns data correctly",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-002"]
    },
    {
      "id": "US-004",
      "title": "Update validation schemas for flat labor pricing",
      "description": "Update validation schemas in `lib/validations/`:\n\n**File: `lib/validations/skladowe.ts`**\n- REMOVE: `createSkladowaRobociznaSchema`, `CreateSkladowaRobociznaInput`, `jednostkaRobociznaOptions`\n- KEEP: all material-related schemas (createSkladowaMaterialSchema, etc.)\n\n**File: `lib/validations/kosztorys.ts`**\n- REMOVE: `updateSkladowaRSchema` (z.object({ stawka, podwykonawca_id }))\n- ADD: `updateCenaRobociznySchema = z.object({ cena_robocizny: z.number().min(0, 'Cena nie może być ujemna'), podwykonawca_id: z.string().uuid().nullable().optional() })` and export the type\n\n**File: `lib/validations/pozycje.ts`**\n- ADD: `cena_robocizny: z.number().min(0).nullable().optional()` to the pozycja creation/update schema (if a schema for creating/editing library positions exists)\n\nDo NOT change any component or action files yet — only validation schemas.",
      "acceptanceCriteria": [
        "createSkladowaRobociznaSchema removed from lib/validations/skladowe.ts",
        "CreateSkladowaRobociznaInput type no longer exported",
        "jednostkaRobociznaOptions no longer exported",
        "updateSkladowaRSchema removed from lib/validations/kosztorys.ts",
        "updateCenaRobociznySchema exists with cena_robocizny (number min 0) and optional podwykonawca_id",
        "Material schemas in skladowe.ts unchanged",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-003"]
    },
    {
      "id": "US-005",
      "title": "Update server actions: remove robocizna CRUD, update kosztorys actions",
      "description": "Update server actions to use flat cena_robocizny instead of skladowe robocizna.\n\n**File: `actions/skladowe.ts`**\n- REMOVE: `SkladowaRobocizna` interface (lines ~19-29)\n- REMOVE: `createSkladowaRobocizna()` function (lines ~46-87)\n- REMOVE: `updateSkladowaRobocizna()` function (lines ~89-118)\n- REMOVE: `deleteSkladowaRobocizna()` function (lines ~120-136)\n- KEEP: All material functions unchanged\n\n**File: `actions/kosztorys.ts`**\n- REMOVE: `SkladowaR` interface (lines ~68-78)\n- REMOVE: `BibliotekaSkladowaR` interface (lines ~98-105)\n- REMOVE: `updateKosztorysSkladowaR()` function (lines ~707-737)\n- REMOVE: `resetSkladowaR()` function (lines ~775-792)\n- UPDATE `getKosztorysPozycjaDetail()` (lines ~282-416):\n  - Remove fetch of skladoweR (kosztorys_skladowe_robocizna query, lines ~307-315)\n  - Remove fetch of bibliotekaSkladoweR (biblioteka_skladowe_robocizna query, lines ~342-349)\n  - Add cena_robocizny, cena_robocizny_zrodlowa, cena_robocizny_zrodlo, podwykonawca_id to the returned detail\n  - Remove skladoweR and bibliotekaSkladoweR from the return object\n- UPDATE `addPositionFromLibrary()` (lines ~525-670):\n  - Remove lines 591-621 (copy robocizna skladowe from library)\n  - Instead: set cena_robocizny on the kosztorys_pozycje INSERT:\n    1. Find cheapest active stawka from stawki_podwykonawcow for this pozycja_biblioteka_id → zrodlo='podwykonawca'\n    2. Else use pozycje_biblioteka.cena_robocizny → zrodlo='biblioteka'\n    3. Else 0 → zrodlo='reczna'\n    Set cena_robocizny_zrodlowa = same value, podwykonawca_id from cheapest stawka\n- UPDATE `resetPozycjaToLibrary()` (lines ~817-920):\n  - Remove robocizna skladowe matching/reset (lines ~868-881)\n  - Instead: reset cena_robocizny from library/subcontractor (same priority as addPositionFromLibrary)\n  - Set cena_robocizny_zrodlowa = new value\n- ADD new `updateCenaRobocizny(pozycjaId: string, input: { cena_robocizny: number, podwykonawca_id?: string | null })` function:\n  - Validates with updateCenaRobociznySchema\n  - Updates kosztorys_pozycje: cena_robocizny, podwykonawca_id, cena_robocizny_zrodlo='reczna' (or 'podwykonawca' if podwykonawca_id provided)\n  - revalidatePath\n\n**File: `actions/pozycje.ts`**\n- Remove `biblioteka_skladowe_robocizna(*)` from all .select() calls\n- Add `cena_robocizny` to select and create/update operations for library positions\n\n**File: `actions/podwykonawcy.ts`**\n- Update `getPodwykonawcaPozycje()` if it queries biblioteka_skladowe_robocizna — change to query stawki_podwykonawcow joined with pozycje_biblioteka instead\n\nFix all TypeScript errors from removed interfaces/functions. Run `npm run build` to verify.",
      "acceptanceCriteria": [
        "SkladowaRobocizna interface removed from actions/skladowe.ts",
        "createSkladowaRobocizna, updateSkladowaRobocizna, deleteSkladowaRobocizna removed",
        "SkladowaR and BibliotekaSkladowaR interfaces removed from actions/kosztorys.ts",
        "updateKosztorysSkladowaR and resetSkladowaR removed",
        "getKosztorysPozycjaDetail returns cena_robocizny fields instead of skladoweR",
        "addPositionFromLibrary sets cena_robocizny with priority: cheapest subcontractor > library > 0",
        "addPositionFromLibrary does NOT insert into kosztorys_skladowe_robocizna",
        "resetPozycjaToLibrary resets cena_robocizny instead of skladowe R matching",
        "New updateCenaRobocizny function exists and validates input",
        "actions/pozycje.ts no longer references biblioteka_skladowe_robocizna",
        "actions/pozycje.ts includes cena_robocizny in selects",
        "npm run build passes",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-004"]
    },
    {
      "id": "US-006",
      "title": "Update utility: obliczCenePozycji in lib/utils/pozycje.ts",
      "description": "Simplify the library position cost calculation utility.\n\n**File: `lib/utils/pozycje.ts`**\n- Update `obliczCenePozycji` function:\n  - OLD: `robocizna = reduce over biblioteka_skladowe_robocizna[] → sum(stawka_domyslna * norma_domyslna)`\n  - NEW: `robocizna = pozycja.cena_robocizny ?? 0`\n- Update the `PozycjaZeSkladowymi` type/interface to include `cena_robocizny: number | null` instead of `biblioteka_skladowe_robocizna` array\n- Keep material calculation unchanged (still reduces over biblioteka_skladowe_materialy)\n\nThis utility is used in library position display to show total cost preview.",
      "acceptanceCriteria": [
        "obliczCenePozycji uses pozycja.cena_robocizny instead of reducing over skladowe array",
        "PozycjaZeSkladowymi type includes cena_robocizny field",
        "PozycjaZeSkladowymi type does NOT reference biblioteka_skladowe_robocizna",
        "Material calculation unchanged",
        "npm run build passes",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-005"]
    },
    {
      "id": "US-007",
      "title": "Update UI: library pozycja detail panel — cena_robocizny field",
      "description": "Update the library position detail panel to show/edit flat cena_robocizny instead of robocizna skladowe list.\n\n**File: `app/(app)/pozycje/_components/pozycja-detail-panel.tsx`**\n- Remove the section that displays `biblioteka_skladowe_robocizna` array (the list of robocizna components with add/edit/delete buttons)\n- Add an editable `cena_robocizny` field:\n  - Label: 'Cena robocizny za jm' (or similar)\n  - Input: number, formatted as currency (zł/jm suffix)\n  - On blur: save via server action (update pozycja_biblioteka.cena_robocizny)\n  - Show null as empty/placeholder '—'\n- Keep the material skladowe section UNCHANGED\n\n**File: `app/(app)/pozycje/_components/panels/skladowa-panel.tsx`**\n- Remove the `robocizna` branch from TYPE_CONFIG\n- Remove `robociznaForm` and `onSubmitRobocizna` handler\n- Remove robocizna-specific form fields\n- The panel now only handles materials (type='material')\n- If the panel is invoked with type='robocizna', it should either not open or redirect\n\n**File: `app/(app)/pozycje/_components/skladowe-section.tsx`**\n- Remove any robocizna-specific rendering logic\n- This component now only renders material components\n- Remove 'Add robocizna' button if it exists\n\nVerify at localhost:3000/pozycje by opening a position detail panel — should show flat cena_robocizny field instead of robocizna component list.",
      "acceptanceCriteria": [
        "Pozycja detail panel shows editable cena_robocizny field with zł/jm label",
        "Editing cena_robocizny and blurring saves to database",
        "No robocizna skladowe list visible in detail panel",
        "skladowa-panel.tsx does not handle robocizna type",
        "skladowe-section.tsx only renders material components",
        "Material skladowe section unchanged",
        "npm run build passes",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 7,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-006"]
    },
    {
      "id": "US-008",
      "title": "Update UI: kosztorys pozycja detail panel — flat cena_robocizny with source badge",
      "description": "Update the kosztorys position detail panel to show flat cena_robocizny instead of robocizna skladowe list.\n\n**File: `app/(app)/projekty/[projektId]/kosztorys/_components/panels/pozycja-detail-panel.tsx`**\n- Remove the entire `SkladowaRRow` component (~lines 401-484) — inline edit of individual robocizna components\n- Remove the robocizna section that maps over `detail.skladoweR` (~lines 273-297)\n- Add new robocizna section showing:\n  - Label: 'Robocizna za jm'\n  - Editable cena_robocizny input (number, currency format)\n  - Source badge: 'Biblioteka' | 'Podwykonawca' | 'Ręczna' based on cena_robocizny_zrodlo (use colored badges similar to specjalizacja badges)\n  - Override indicator: if r_is_override (cena != zrodlowa), show original price crossed out + reset button\n  - Podwykonawca dropdown (select from available podwykonawcy list)\n  - On save: call updateCenaRobocizny action\n  - Reset button: calls resetPozycjaToLibrary for R only\n- Update the detail interface used by this component to expect cena_robocizny fields instead of skladoweR array\n- Keep material section UNCHANGED\n\nVerify at localhost:3000/projekty/[id]/kosztorys by opening a position — should show flat R field with source info.",
      "acceptanceCriteria": [
        "SkladowaRRow component removed from kosztorys detail panel",
        "No robocizna skladowe list in panel",
        "Editable cena_robocizny field with currency format",
        "Source badge shows cena_robocizny_zrodlo as colored badge",
        "Override indicator when cena differs from zrodlowa (crossed out original + reset)",
        "Podwykonawca dropdown for selecting subcontractor",
        "Save calls updateCenaRobocizny action successfully",
        "Material section unchanged",
        "npm run build passes",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 8,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-007"]
    },
    {
      "id": "US-009",
      "title": "Update UI: library drawer badge R:count → R:price",
      "description": "Update the library drawer in kosztorys to show labor price instead of component count.\n\n**File: `app/(app)/projekty/[projektId]/kosztorys/_components/library-drawer.tsx`**\n- Change the robocizna badge from `R:{count}` (blue) to `R:{formatCurrency(pos.cenaRobocizny)}` (blue)\n- If cena_robocizny is null or 0, show 'R:—' instead\n- Update the data fetching to include cena_robocizny from pozycje_biblioteka\n- Remove any reference to biblioteka_skladowe_robocizna count\n\nThe material badge `M:{count}` stays as-is (materials still have components).\n\nVerify at localhost:3000/projekty/[id]/kosztorys by opening the library drawer — R badges should show prices.",
      "acceptanceCriteria": [
        "Library drawer R badge shows formatted price instead of component count",
        "R badge shows 'R:—' when cena_robocizny is null or 0",
        "Material M badge unchanged (still shows count)",
        "No reference to biblioteka_skladowe_robocizna in library drawer queries",
        "npm run build passes",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 9,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-008"]
    },
    {
      "id": "US-010",
      "title": "Update tests for flat labor pricing model",
      "description": "Rewrite tests to validate the new flat labor pricing model.\n\n**File: `tests/pozycja-robocizna.test.ts`**\n- REWRITE entire test file:\n  - Remove biblioteka_skladowe_robocizna creation\n  - Test: pozycja_biblioteka has cena_robocizny field set correctly\n  - Test: stawki_podwykonawcow still links subcontractor to pozycja\n  - Test: multiple subcontractors with different rates\n\n**File: `tests/pozycja-do-kosztorysu.test.ts`**\n- REWRITE to use flat cena_robocizny:\n  - Remove createKosztorysSkladowaR calls\n  - Instead: set cena_robocizny on kosztorys_pozycje\n  - Update expected calculations:\n    - r_jednostkowy = cena_robocizny (e.g. 6.90)\n    - r_robocizna = cena_robocizny × ilosc\n    - razem = (r_robocizna + m_materialy) × (1 + narzut%)\n  - Keep material tests unchanged\n  - Keep manual material test unchanged\n\n**File: `tests/helpers/setup.ts`**\n- REMOVE: `createBibliotekaSkladowaR` helper\n- REMOVE: `createKosztorysSkladowaR` helper\n- ADD: `updatePozycjaCenaRobocizny(pozycjaId, cenaRobocizny)` helper if needed\n- KEEP: all material helpers\n\nRun `npm run test` to verify all tests pass.",
      "acceptanceCriteria": [
        "pozycja-robocizna.test.ts passes with flat cena_robocizny model",
        "pozycja-do-kosztorysu.test.ts passes with flat R calculation",
        "No references to biblioteka_skladowe_robocizna or kosztorys_skladowe_robocizna in test files",
        "createBibliotekaSkladowaR and createKosztorysSkladowaR removed from helpers",
        "Material tests unchanged and passing",
        "npm run test passes (all tests green)",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-005"]
    },
    {
      "id": "US-011",
      "title": "Final build verification and cleanup",
      "description": "Run full verification suite and clean up any remaining references.\n\n1. Search entire codebase for any remaining references to:\n   - 'biblioteka_skladowe_robocizna'\n   - 'kosztorys_skladowe_robocizna'\n   - 'skladoweR' / 'skladowe_r' / 'SkladowaR'\n   - 'norma_domyslna' in robocizna context (material norma_domyslna is fine)\n   - 'updateKosztorysSkladowaR' / 'resetSkladowaR'\n   Remove any found references (except in migration files 001-016 which are historical).\n\n2. Run `npm run build` — must pass with zero errors\n3. Run `npm run lint` — fix any new warnings introduced by this feature\n4. Run `npm run test` — all tests must pass\n5. Verify dev server works:\n   - localhost:3000/pozycje — library positions show cena_robocizny\n   - localhost:3000/projekty/[id]/kosztorys — R column still shows correct values, detail panel has flat R editing\n\nFix any issues found.",
      "acceptanceCriteria": [
        "No references to robocizna skladowe tables outside of migration files 001-016",
        "No references to SkladowaR/skladoweR interfaces outside migration files",
        "npm run build passes with zero errors",
        "npm run lint passes (no new warnings)",
        "npm run test passes (all tests green)",
        "Pozycje page shows cena_robocizny for library positions",
        "Kosztorys page shows correct R values from flat pricing",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-008", "US-009", "US-010"]
    }
  ]
}
