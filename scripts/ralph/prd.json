{
  "project": "PLANY App",
  "branchName": "ralph/master-data-ux-upgrade",
  "description": "UX upgrade for Materialy, Dostawcy, Podwykonawcy pages - stats bars, column sorting, better columns (price ranges, value), additional filters (status, specjalizacja), showInactive toggles",
  "mode": "feature",
  "baseBranch": "main",
  "userStories": [
    {
      "id": "US-001",
      "title": "DB migration: enhanced aggregation RPCs",
      "description": "Apply a single Supabase migration that creates/replaces 6 PostgreSQL functions:\n\n1. **get_materialy_aggregated** (REPLACE) — add `najgorsza_cena` (MAX), `p_status_cenowy` filter, `p_show_inactive`, `p_sort`/`p_order` params. Keep existing params unchanged. Add CASE-based ORDER BY for sort columns: nazwa, sku, pozycje, dostawcy, cena.\n\n2. **get_materialy_stats** (NEW) — returns: total active products, with_suppliers count, without_suppliers count, avg best price.\n\n3. **get_dostawcy_aggregated** (NEW) — replaces N+1 pattern. Params: p_search, p_show_inactive, p_sort, p_order, p_limit, p_offset. Returns: id, nazwa, kod, kontakt, aktywny, produkty_count (COUNT DISTINCT ceny_dostawcow), total_wartosc (SUM cena_netto), total_count. CASE-based ORDER BY: nazwa, kod, produkty, wartosc.\n\n4. **get_dostawcy_stats** (NEW) — returns: total active suppliers, total products in cenniki, avg products per supplier.\n\n5. **get_podwykonawcy_aggregated** (NEW) — replaces N+1 pattern. Params: p_search, p_specjalizacja, p_show_inactive, p_sort, p_order, p_limit, p_offset. Returns: id, nazwa, specjalizacja, kontakt, aktywny, stawki_count, min_stawka, max_stawka, total_count. CASE-based ORDER BY: nazwa, specjalizacja, stawki, min_stawka.\n\n6. **get_podwykonawcy_stats** (NEW) — returns: total active subcontractors, total stawki, avg stawka.\n\nUse `apply_migration` with name `enhanced_aggregations`. All functions are LANGUAGE plpgsql STABLE.\n\nSee `docs/plans/2026-02-08-master-data-ux-upgrade.md` US-001 Step 1 for full SQL.",
      "acceptanceCriteria": [
        "Migration applied successfully via Supabase",
        "get_materialy_aggregated returns najgorsza_cena column and accepts p_status_cenowy, p_show_inactive, p_sort, p_order params",
        "get_materialy_stats returns total, with_suppliers, without_suppliers, avg_price",
        "get_dostawcy_aggregated returns produkty_count and total_wartosc with sort support",
        "get_dostawcy_stats returns total, total_products, avg_products",
        "get_podwykonawcy_aggregated returns stawki_count, min_stawka, max_stawka with sort and specjalizacja filter",
        "get_podwykonawcy_stats returns total, total_stawki, avg_stawka",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "All 6 RPCs created and verified. get_materialy_aggregated updated with najgorsza_cena, sort, status_cenowy, show_inactive. New: get_materialy_stats, get_dostawcy_aggregated, get_dostawcy_stats, get_podwykonawcy_aggregated, get_podwykonawcy_stats.",
      "dependsOn": []
    },
    {
      "id": "US-002",
      "title": "Update validation schemas for new filter params",
      "description": "Update all 3 filter schemas to support new URL params.\n\n**File: `lib/validations/materialy.ts`**\nAdd to `materialyFiltersSchema`:\n- `statusCenowy: z.enum(['with_suppliers', 'without_suppliers']).optional()`\n- `showInactive: z.coerce.boolean().optional().default(false)`\n- `sort: z.string().optional()`\n- `order: z.enum(['asc', 'desc']).optional()`\n\n**File: `lib/validations/dostawcy.ts`**\nAdd to `dostawcyFiltersSchema`:\n- `sort: z.string().optional()`\n- `order: z.enum(['asc', 'desc']).optional()`\n(showInactive already exists)\n\n**File: `lib/validations/podwykonawcy.ts`**\nAdd to `podwykonawcyFiltersSchema`:\n- `specjalizacja: z.string().optional()`\n- `sort: z.string().optional()`\n- `order: z.enum(['asc', 'desc']).optional()`\n(showInactive already exists)\n\nAll new fields have defaults or are optional, so existing code continues to work.",
      "acceptanceCriteria": [
        "materialyFiltersSchema has statusCenowy, showInactive, sort, order fields",
        "dostawcyFiltersSchema has sort, order fields",
        "podwykonawcyFiltersSchema has specjalizacja, sort, order fields",
        "MaterialyFilters type includes new fields",
        "DostawcyFilters type includes new fields",
        "PodwykonawcyFilters type includes new fields",
        "npm run build passes",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Added statusCenowy, showInactive, sort, order to materialy; sort, order to dostawcy; specjalizacja, sort, order to podwykonawcy. Updated page.tsx files to pass new params.",
      "dependsOn": ["US-001"]
    },
    {
      "id": "US-003",
      "title": "Update server actions to use new RPCs",
      "description": "Update all 3 action files to use new RPCs and return new fields.\n\n**File: `actions/materialy.ts`**\n1. Add `najgorszaCena: number | null` to `ProduktWithAggregation` interface\n2. Update `getMaterialy()` to pass new params to RPC: p_status_cenowy, p_show_inactive, p_sort, p_order. Map `najgorsza_cena` from result.\n3. Add `MaterialyStats` interface and `getMaterialyStats()` action that calls `get_materialy_stats` RPC.\n\n**File: `actions/dostawcy.ts`**\n1. Add `totalWartosc: number` to `DostawcaWithCount` interface\n2. REPLACE the N+1 pattern in `getDostawcy()` with single `supabase.rpc('get_dostawcy_aggregated', ...)` call. Map `produkty_count` and `total_wartosc`. Remove the old two-query pattern (lines ~77-111).\n3. Add `DostawcyStats` interface and `getDostawcyStats()` action.\n\n**File: `actions/podwykonawcy.ts`**\n1. Add `minStawka: number | null` and `maxStawka: number | null` to `PodwykonawcaWithCount` interface\n2. REPLACE the N+1 pattern in `getPodwykonawcy()` with `supabase.rpc('get_podwykonawcy_aggregated', ...)` call. Map new fields. Remove old two-query pattern (lines ~67-107).\n3. Add `PodwykonawcyStats` interface and `getPodwykonawcyStats()` action.\n4. Add `getDistinctSpecjalizacje()` action: query distinct non-null specjalizacja values from podwykonawcy where aktywny=true, return string[].\n\nAll existing action signatures stay the same. New fields are additive — tables don't reference them yet.",
      "acceptanceCriteria": [
        "ProduktWithAggregation has najgorszaCena field",
        "getMaterialy passes statusCenowy, showInactive, sort, order to RPC",
        "getMaterialyStats returns MaterialyStats from RPC",
        "DostawcaWithCount has totalWartosc field",
        "getDostawcy uses get_dostawcy_aggregated RPC (no more N+1)",
        "getDostawcyStats returns DostawcyStats from RPC",
        "PodwykonawcaWithCount has minStawka, maxStawka fields",
        "getPodwykonawcy uses get_podwykonawcy_aggregated RPC (no more N+1)",
        "getPodwykonawcyStats returns PodwykonawcyStats from RPC",
        "getDistinctSpecjalizacje returns unique specjalizacja strings",
        "npm run build passes",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Updated all 3 action files. Materialy: added najgorszaCena + getMaterialyStats. Dostawcy: replaced N+1 with RPC, added totalWartosc + getDostawcyStats. Podwykonawcy: replaced N+1 with RPC, added minStawka/maxStawka + getPodwykonawcyStats + getDistinctSpecjalizacje.",
      "dependsOn": ["US-002"]
    },
    {
      "id": "US-004",
      "title": "Create shared StatsBar component",
      "description": "Create `components/stats-bar.tsx` — a reusable component used by all 3 master data pages.\n\nInterface:\n```typescript\ninterface StatItem {\n  label: string;\n  value: string;\n  sublabel?: string;\n}\ninterface StatsBarProps {\n  items: StatItem[];\n}\n```\n\nRender a responsive grid of glass cards:\n- Container: `grid grid-cols-2 md:grid-cols-4 gap-3`\n- Each card: `bg-[#1A1A24]/40 backdrop-blur-sm border border-white/[0.06] rounded-lg px-4 py-3`\n- Label: `text-xs text-white/40 uppercase tracking-wider mb-1`\n- Value: `text-lg font-mono font-semibold text-amber-500`\n- Optional sublabel: `text-xs text-white/30 mt-0.5`\n\nExport as named export `StatsBar`.",
      "acceptanceCriteria": [
        "components/stats-bar.tsx created with StatsBar and StatItem exports",
        "Renders responsive grid (2 cols mobile, 4 cols desktop)",
        "Each card has glass effect styling matching app design system",
        "Values render in amber font-mono",
        "Optional sublabel renders below value",
        "npm run build passes",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Created components/stats-bar.tsx with StatsBar component. Glass card grid, amber font-mono values, optional sublabel.",
      "dependsOn": []
    },
    {
      "id": "US-005",
      "title": "Materialy page UX upgrade",
      "description": "Upgrade the Materialy page with stats bar, better columns, sorting, and new filters.\n\n**File: `app/(app)/materialy/page.tsx`**\n- Import getMaterialyStats\n- Add statusCenowy, showInactive, sort, order to searchParams type\n- Fetch stats in parallel: `const [result, stats] = await Promise.all([getMaterialy(filters), getMaterialyStats()])`\n- Pass stats to MaterialyView\n\n**File: `app/(app)/materialy/_components/materialy-view.tsx`**\n- Import StatsBar from `@/components/stats-bar`\n- Add `stats: MaterialyStats` to props\n- Render StatsBar between breadcrumb and filters with items: 'Produkty' (total), 'Z dostawcami' (withSuppliers), 'Bez dostawców' (withoutSuppliers), 'Śr. cena' (avgPrice formatted as 'XX,XX zł' or '—')\n- Update breadcrumb: `Materiały (${initialData.totalCount})` instead of `Materiały`\n- Add `useRouter` and `useSearchParams` for sort handling\n- Create `handleSortChange(column: string)` that toggles asc/desc via URL params, resets page to 1\n- Pass sort, order, onSortChange to MaterialyTable\n\n**File: `app/(app)/materialy/_components/materialy-table.tsx`**\n- Add props: `sort?: string`, `order?: 'asc' | 'desc'`, `onSortChange: (column: string) => void`\n- Change 'Najlepsza cena' column to 'Cena' showing price range: if min === max or max is null → single price, else `min – max zł`. Use `—` for null.\n- Make column headers clickable with sort indicator (ArrowUp from lucide, rotated 180deg for desc). Sort keys: 'nazwa', skip jednostka, 'pozycje', 'dostawcy', 'cena'.\n- Add inactive row styling: `!row.original.aktywny && 'opacity-50'`\n\n**File: `app/(app)/materialy/_components/materialy-filters.tsx`**\n- Add Select dropdown for statusCenowy: 'Wszystkie' | 'Z dostawcami' | 'Bez dostawców'\n- Add Checkbox for showInactive with label 'Nieaktywne'\n- Both update URL params and reset page to 1\n\nVerify at localhost:3000/materialy:\n- Stats bar shows 4 KPI cards\n- Price column shows ranges for multi-supplier products\n- Clicking headers sorts (arrow indicator shows direction)\n- Status filter narrows results\n- showInactive toggle reveals deactivated items (dimmed)",
      "acceptanceCriteria": [
        "Stats bar renders with 4 cards: Produkty, Z dostawcami, Bez dostawców, Śr. cena",
        "Breadcrumb shows total count: 'Materiały (N)'",
        "Price column shows range 'min – max zł' for multi-supplier products",
        "Price column shows single price for single-supplier products",
        "Price column shows '—' for products without suppliers",
        "Column headers clickable with sort arrows (nazwa, pozycje, dostawcy, cena)",
        "Sorting persists in URL params (?sort=nazwa&order=desc)",
        "Status filter dropdown works: Wszystkie / Z dostawcami / Bez dostawców",
        "showInactive checkbox reveals inactive products with opacity-50 styling",
        "Inactive rows are visually dimmed",
        "All filters/sort reset page to 1",
        "npm run build passes",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 5,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-003", "US-004"]
    },
    {
      "id": "US-006",
      "title": "Dostawcy page UX upgrade",
      "description": "Upgrade the Dostawcy page with stats bar, value column, sorting, and showInactive toggle.\n\n**File: `app/(app)/dostawcy/page.tsx`**\n- Import getDostawcyStats\n- Add sort, order to searchParams type\n- Fetch stats in parallel with getDostawcy\n- Pass stats to DostawcyView\n\n**File: `app/(app)/dostawcy/_components/dostawcy-view.tsx`**\n- Import StatsBar\n- Add `stats: DostawcyStats` to props\n- Render StatsBar with: 'Dostawcy' (total), 'Pozycji w cennikach' (totalProducts), 'Śr. produktów/dostawca' (avgProducts)\n- Update breadcrumb: `Dostawcy (${initialData.totalCount})`\n- Add sort handling (same pattern as materialy)\n- Pass sort, order, onSortChange to DostawcyTable\n\n**File: `app/(app)/dostawcy/_components/dostawcy-table.tsx`**\n- Add 'Wartość cennika' column showing totalWartosc formatted as 'X XXX,XX zł' (space thousands separator). Show '—' if 0.\n- Make headers clickable with sort indicator. Sort keys: 'nazwa', 'kod', 'produkty', 'wartosc'.\n- Add inactive row styling (opacity-50)\n\n**File: `app/(app)/dostawcy/_components/dostawcy-filters.tsx`**\n- Add Checkbox for showInactive with label 'Nieaktywne' (currently backend supports it but no UI toggle)\n- Update URL params on change, reset page\n\nVerify at localhost:3000/dostawcy:\n- Stats bar shows 3 KPI cards\n- New value column visible\n- Sorting works on all columns\n- showInactive toggle works",
      "acceptanceCriteria": [
        "Stats bar renders with 3 cards: Dostawcy, Pozycji w cennikach, Śr. produktów/dostawca",
        "Breadcrumb shows count: 'Dostawcy (N)'",
        "New 'Wartość cennika' column shows formatted sum in amber font-mono",
        "Value column shows '—' for suppliers with no products",
        "Column headers clickable with sort arrows (nazwa, kod, produkty, wartosc)",
        "Sorting persists in URL params",
        "showInactive checkbox visible and functional",
        "Inactive rows dimmed with opacity-50",
        "npm run build passes",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-003", "US-004"]
    },
    {
      "id": "US-007",
      "title": "Podwykonawcy page UX upgrade",
      "description": "Upgrade the Podwykonawcy page with stats bar, rate range column, specjalizacja badges/filter, sorting, and showInactive.\n\n**File: `app/(app)/podwykonawcy/page.tsx`**\n- Import getPodwykonawcyStats and getDistinctSpecjalizacje\n- Add specjalizacja, sort, order to searchParams type\n- Fetch stats + specjalizacje in parallel with getPodwykonawcy\n- Pass all to PodwykonawcyView\n\n**File: `app/(app)/podwykonawcy/_components/podwykonawcy-view.tsx`**\n- Import StatsBar\n- Add stats + specjalizacje to props\n- Render StatsBar: 'Podwykonawcy' (total), 'Stawek ogółem' (totalStawki), 'Śr. stawka' (avgStawka formatted as 'XX,XX zł' or '—')\n- Breadcrumb: `Podwykonawcy (${initialData.totalCount})`\n- Add sort handling, pass to table\n\n**File: `app/(app)/podwykonawcy/_components/podwykonawcy-table.tsx`**\n- Replace 'Stawki' count column with 'Zakres stawek' range column:\n  - If stawkiCount=0 → '—'\n  - If min === max → 'XX,XX zł (N)' where N is count\n  - If min !== max → 'min – max zł (N)'\n  - Value in amber font-mono, count in text-white/30 text-xs\n- Replace plain 'Specjalizacja' text with colored badge:\n  - Define color map: e.g. 'GK'→blue, 'Tynki'→green, 'Elektryka'→yellow, 'Hydraulika'→cyan\n  - Default: bg-white/5 text-white/60 border-white/10\n  - Badge: `inline-flex px-2 py-0.5 rounded-full text-xs border`\n  - Show '—' if null\n- Sortable headers: 'nazwa', 'specjalizacja', 'stawki' (sorts by min_stawka), skip kontakt\n- Inactive row styling\n\n**File: `app/(app)/podwykonawcy/_components/podwykonawcy-filters.tsx`**\n- Add Select dropdown for specjalizacja populated from specjalizacje prop (distinct values from DB)\n  - Options: 'Wszystkie' + each unique specjalizacja value\n  - Sets ?specjalizacja=value URL param\n- Add Checkbox for showInactive\n- Both reset page to 1\n\nVerify at localhost:3000/podwykonawcy:\n- Stats bar shows 3 KPI cards\n- Rate range column shows min-max with count\n- Specjalizacja badges are colored\n- Specjalizacja filter dropdown works\n- Sorting works\n- showInactive toggle works",
      "acceptanceCriteria": [
        "Stats bar renders with 3 cards: Podwykonawcy, Stawek ogółem, Śr. stawka",
        "Breadcrumb shows count: 'Podwykonawcy (N)'",
        "'Zakres stawek' column shows range 'min – max zł (count)' in amber font-mono",
        "Rate column shows single rate for single-rate subcontractors",
        "Rate column shows '—' for subcontractors with no rates",
        "Specjalizacja shows as colored badge (not plain text)",
        "Specjalizacja null shows '—'",
        "Specjalizacja filter dropdown populated from DB with distinct values",
        "Specjalizacja filter narrows results correctly",
        "Column headers clickable with sort arrows (nazwa, specjalizacja, stawki)",
        "showInactive checkbox visible and functional",
        "Inactive rows dimmed with opacity-50",
        "npm run build passes",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 7,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-003", "US-004"]
    },
    {
      "id": "US-008",
      "title": "Final build verification and polish",
      "description": "Run full build, lint, and verify all 3 pages work correctly.\n\n1. Run `npm run build` — must pass clean\n2. Run `npm run lint` — fix any new warnings\n3. Run `npm run test` — existing tests must still pass\n4. Start dev server (`npm run dev`) and verify:\n   - localhost:3000/materialy: stats bar, price ranges, sorting, filters all work\n   - localhost:3000/dostawcy: stats bar, value column, sorting, showInactive all work\n   - localhost:3000/podwykonawcy: stats bar, rate ranges, badges, spec filter, sorting all work\n5. Fix any remaining issues found during verification",
      "acceptanceCriteria": [
        "npm run build passes with zero errors",
        "npm run lint passes",
        "npm run test passes (all existing tests still green)",
        "All 3 pages render correctly with new features",
        "No console errors in browser",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-005", "US-006", "US-007"]
    }
  ]
}
