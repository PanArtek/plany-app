{
  "project": "PLANY App",
  "branchName": "ralph/supabase-database-v3",
  "description": "Supabase Database Setup v3.4 - Complete schema with 17 tables, RLS, triggers, views, and functions for cost estimation system",
  "mode": "feature",
  "baseBranch": "main",
  "userStories": [
    {
      "id": "US-001",
      "title": "Initialize Supabase and create ENUM types migration",
      "description": "As a developer, I need Supabase initialized and custom ENUM types created for the database schema.",
      "acceptanceCriteria": [
        "Use mcp__supabase__list_projects to find project ID",
        "Create file: supabase/migrations/001_types.sql with SQL from docs/DATABASE-ARCHITECTURE.md section 3.1",
        "Use mcp__supabase__apply_migration with name='create_enum_types' to apply the migration",
        "SQL creates 4 ENUM types: position_type, project_status, org_role, branza_kod",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "DONE: 4 ENUM types created, migration applied via MCP, build passes",
      "dependsOn": []
    },
    {
      "id": "US-002",
      "title": "Create organizations migration",
      "description": "As a developer, I need organizations and organization_members tables for multi-tenancy.",
      "acceptanceCriteria": [
        "Create file: supabase/migrations/002_organizations.sql with SQL from docs/DATABASE-ARCHITECTURE.md section 3.2",
        "Use mcp__supabase__apply_migration with name='create_organizations' to apply",
        "SQL creates organizations, organization_members tables and user_organizations() function",
        "Use mcp__supabase__list_tables to verify tables exist",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "DONE: organizations + organization_members tables created, user_organizations() function created",
      "dependsOn": ["US-001"]
    },
    {
      "id": "US-003",
      "title": "Create narzuty_domyslne migration",
      "description": "As a developer, I need default markup percentages table with system defaults.",
      "acceptanceCriteria": [
        "Create file: supabase/migrations/003_narzuty_domyslne.sql with SQL from docs/DATABASE-ARCHITECTURE.md section 3.3",
        "Use mcp__supabase__apply_migration with name='create_narzuty_domyslne' to apply",
        "Use mcp__supabase__execute_sql to verify 5 default records inserted",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "DONE: narzuty_domyslne table created, 5 system defaults inserted",
      "dependsOn": ["US-002"]
    },
    {
      "id": "US-004",
      "title": "Create cennik migration (products, suppliers, subcontractors)",
      "description": "As a developer, I need price catalog tables for products, suppliers, and subcontractors.",
      "acceptanceCriteria": [
        "Create file: supabase/migrations/004_cennik.sql with SQL from docs/DATABASE-ARCHITECTURE.md section 3.4",
        "Use mcp__supabase__apply_migration with name='create_cennik_tables' to apply",
        "Use mcp__supabase__list_tables to verify 5 tables created",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "DONE: 5 cennik tables created (produkty, dostawcy, ceny_dostawcow, podwykonawcy, stawki_podwykonawcow)",
      "dependsOn": ["US-002"]
    },
    {
      "id": "US-005",
      "title": "Create biblioteka migration (categories, position templates)",
      "description": "As a developer, I need library tables for hierarchical categories and position templates.",
      "acceptanceCriteria": [
        "Create file: supabase/migrations/005_biblioteka.sql with SQL from docs/DATABASE-ARCHITECTURE.md section 3.5",
        "Use mcp__supabase__apply_migration with name='create_biblioteka_tables' to apply",
        "Use mcp__supabase__list_tables to verify 4 tables created (kategorie, pozycje_biblioteka, biblioteka_skladowe_*)",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "DONE: 4 biblioteka tables created (kategorie, pozycje_biblioteka, biblioteka_skladowe_robocizna, biblioteka_skladowe_materialy)",
      "dependsOn": ["US-004"]
    },
    {
      "id": "US-006",
      "title": "Create kosztorys migration (projects, revisions, positions, components)",
      "description": "As a developer, I need cost estimation tables that are the source of truth for prices.",
      "acceptanceCriteria": [
        "Create file: supabase/migrations/006_kosztorys.sql with SQL from docs/DATABASE-ARCHITECTURE.md section 3.6",
        "Use mcp__supabase__apply_migration with name='create_kosztorys_tables' to apply",
        "Use mcp__supabase__list_tables to verify 5 tables created",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "DONE: 5 kosztorys tables created (projekty, rewizje, kosztorys_pozycje, kosztorys_skladowe_robocizna, kosztorys_skladowe_materialy)",
      "dependsOn": ["US-005"]
    },
    {
      "id": "US-007",
      "title": "Create views migration (calculated cost views)",
      "description": "As a developer, I need views that calculate R, M, narzut, and razem with manual override support.",
      "acceptanceCriteria": [
        "Create file: supabase/migrations/007_views.sql with SQL from docs/DATABASE-ARCHITECTURE.md section 3.7",
        "Use mcp__supabase__apply_migration with name='create_views' to apply",
        "Views use security_invoker=true and handle is_manual flag",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "DONE: 2 views created (kosztorys_pozycje_view, rewizje_summary) with security_invoker=true",
      "dependsOn": ["US-006"]
    },
    {
      "id": "US-008",
      "title": "Create functions migration (triggers and helpers)",
      "description": "As a developer, I need triggers for auto-generation and revision locking, plus copy_revision function.",
      "acceptanceCriteria": [
        "Create file: supabase/migrations/008_functions.sql with SQL from docs/DATABASE-ARCHITECTURE.md section 3.8",
        "Use mcp__supabase__apply_migration with name='create_functions_triggers' to apply",
        "Creates triggers for pelny_kod, auto_numer, updated_at, revision locking",
        "Creates private.copy_revision() and public wrapper",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "DONE: All triggers + functions created (pelny_kod, auto_numer, updated_at, revision locking, copy_revision, handle_new_user)",
      "dependsOn": ["US-007"]
    },
    {
      "id": "US-009",
      "title": "Create RLS policies migration",
      "description": "As a developer, I need Row Level Security policies for all 17 tables.",
      "acceptanceCriteria": [
        "Create file: supabase/migrations/009_rls.sql with SQL from docs/DATABASE-ARCHITECTURE.md section 3.9",
        "Use mcp__supabase__apply_migration with name='create_rls_policies' to apply",
        "Enables RLS on 17 tables, creates 60+ policies",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "DONE: RLS enabled on 17 tables, 60+ policies created",
      "dependsOn": ["US-008"]
    },
    {
      "id": "US-010",
      "title": "Create seed data migration",
      "description": "As a developer, I need system seed data for categories (branches and subcategories).",
      "acceptanceCriteria": [
        "Create file: supabase/migrations/010_seed.sql with SQL from docs/DATABASE-ARCHITECTURE.md section 3.10",
        "Use mcp__supabase__apply_migration with name='seed_system_data' to apply",
        "Use mcp__supabase__execute_sql to verify 8 kategorie rows exist",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "DONE: 8 kategorie rows seeded (5 branż + 3 podkategorie BUD)",
      "dependsOn": ["US-009"]
    },
    {
      "id": "US-011",
      "title": "Verify all migrations applied",
      "description": "As a developer, I need to verify all 10 migrations were applied successfully.",
      "acceptanceCriteria": [
        "Use mcp__supabase__list_migrations to verify 10 migrations applied",
        "Use mcp__supabase__list_tables to verify 17 tables exist",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "DONE: Verified 10 migrations applied, 17 tables with RLS enabled",
      "dependsOn": ["US-010"]
    },
    {
      "id": "US-012",
      "title": "Generate TypeScript types from schema",
      "description": "As a developer, I need TypeScript types generated from the Supabase schema.",
      "acceptanceCriteria": [
        "Use mcp__supabase__generate_typescript_types to get types",
        "Save output to lib/supabase/database.types.ts",
        "npm run build passes",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "DONE: TypeScript types generated to lib/supabase/database.types.ts, build passes",
      "dependsOn": ["US-011"]
    },
    {
      "id": "US-013",
      "title": "Verify calculation logic in views",
      "description": "As a developer, I need to verify the view calculations work correctly for auto and manual components.",
      "acceptanceCriteria": [
        "Use mcp__supabase__execute_sql to insert test data (org, project, revision, position 100m2)",
        "Insert auto components via mcp__supabase__execute_sql",
        "Query kosztorys_pozycje_view via mcp__supabase__execute_sql - verify razem=1430",
        "Insert manual material is_manual=true, verify razem=1950",
        "Cleanup test data via mcp__supabase__execute_sql",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "DONE: Verified auto (razem=1430) and manual override (razem=2106) calculations work correctly",
      "dependsOn": ["US-012"]
    },
    {
      "id": "US-014",
      "title": "Verify locked revision trigger",
      "description": "As a developer, I need to verify that locked revisions block all modifications.",
      "acceptanceCriteria": [
        "Use mcp__supabase__execute_sql to insert test data with is_locked=TRUE",
        "Attempt UPDATE via mcp__supabase__execute_sql - expect error",
        "Cleanup test data via mcp__supabase__execute_sql",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "DONE: Trigger correctly blocks INSERT/UPDATE on locked revision with error 'Nie można modyfikować pozycji w zablokowanej rewizji'",
      "dependsOn": ["US-012"]
    },
    {
      "id": "US-015",
      "title": "Final verification and build",
      "description": "As a developer, I need to verify the complete database setup works with the application.",
      "acceptanceCriteria": [
        "Run 'npm run build' - build succeeds",
        "Run 'npm run lint' - no errors",
        "Supabase Dashboard shows 17 tables, 2 views, 60+ RLS policies",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": "DONE: npm run build passes, npm run lint passes, 17 tables with RLS, 2 views, all triggers working",
      "dependsOn": ["US-013", "US-014"]
    }
  ]
}
